---
/* vibepedia サイドバーコンポーネント
 * ナビゲーションリンクと、記事ページでは目次を表示する。
 * デスクトップでは左側固定、モバイルではドロワーメニュー。
 */
import TableOfContents from './TableOfContents.astro';
import { getCollection } from 'astro:content';
import { buildCategorySummariesFromArticles } from '../utils/categories';

interface Props {
  headings?: { depth: number; slug: string; text: string }[];
  isArticle?: boolean;
}

const { headings = [], isArticle = false } = Astro.props;
const base = import.meta.env.BASE_URL;
const categories = isArticle
  ? []
  : buildCategorySummariesFromArticles(await getCollection('articles'));
---

<!-- モバイル用オーバーレイ -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav" aria-label="サイトナビゲーション">
    <div class="nav-section">
      <h3 class="nav-section-title">ナビゲーション</h3>
      <ul class="nav-list">
        <li>
          <a href={base} class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            メインページ
          </a>
        </li>
        <li>
          <a href={`${base}recent-events`} class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            最近の出来事
          </a>
        </li>
        <li>
          <a href={`${base}recent-updates`} class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            最近の更新
          </a>
        </li>
        <li>
          <a href={`${base}random`} class="nav-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 3 21 3 21 8"></polyline>
              <line x1="4" y1="20" x2="21" y2="3"></line>
              <polyline points="21 16 21 21 16 21"></polyline>
              <line x1="15" y1="15" x2="21" y2="21"></line>
              <line x1="4" y1="4" x2="9" y2="9"></line>
            </svg>
            おまかせ表示
          </a>
        </li>
      </ul>
    </div>

    {!isArticle && categories.length > 0 && (
      <div class="nav-section">
        <h3 class="nav-section-title">カテゴリ</h3>
        <ul class="nav-list">
          {categories.map((category) => (
            <li>
              <a href={`${base}categories/${category.slug}`} class="nav-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.59 13.41L11 3H4v7l9.59 9.59a2 2 0 0 0 2.82 0l4.18-4.18a2 2 0 0 0 0-2.82z"></path>
                  <line x1="7" y1="7" x2="7.01" y2="7"></line>
                </svg>
                <span>{category.name}</span>
                <span class="category-count">{category.count}</span>
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}
  </nav>

  {/* 記事ページでのみ目次を表示 */}
  {isArticle && headings.length > 0 && (
    <TableOfContents headings={headings} />
  )}
</aside>

<style>
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 89;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .sidebar-overlay.is-visible {
    display: block;
    opacity: 1;
  }

  .sidebar {
    position: sticky;
    top: var(--header-height);
    width: var(--sidebar-width);
    height: calc(100vh - var(--header-height));
    flex-shrink: 0;
    overflow-y: auto;
    padding: var(--spacing-lg) var(--spacing-md);
    background-color: var(--color-sidebar-bg);
    border-right: 1px solid var(--color-border-light);
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) transparent;
  }

  .sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .sidebar::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
    border-radius: 3px;
  }

  .nav-section {
    margin-bottom: var(--spacing-lg);
  }

  .nav-section-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-tertiary);
    padding: 0 var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
  }

  .nav-list {
    list-style: none;
    padding: 0;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: var(--color-text);
    text-decoration: none;
    transition: background-color var(--transition-fast), color var(--transition-fast);
  }

  .nav-link:visited {
    color: var(--color-text);
  }

  .nav-link:hover {
    background-color: var(--color-border-light);
    color: var(--color-link);
    text-decoration: none;
  }

  .nav-link svg {
    flex-shrink: 0;
    color: var(--color-text-tertiary);
  }

  .category-count {
    margin-left: auto;
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
  }

  .nav-link:hover svg {
    color: var(--color-link);
  }

  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 90;
      height: 100vh;
      transform: translateX(-100%);
      transition: transform var(--transition-normal);
      box-shadow: none;
      padding-top: calc(var(--header-height) + var(--spacing-md));
    }

    .sidebar.is-open {
      transform: translateX(0);
      box-shadow: var(--shadow-lg);
    }
  }
</style>
