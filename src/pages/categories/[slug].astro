---
/* vibepedia カテゴリページ
 * Wikipediaのカテゴリページに近い構成で、階層と索引を表示する。
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import {
  buildCategoryHierarchy,
  countDescendantCategories,
  countSubtreeArticles,
  getCategoryAncestors,
  type CategoryNode,
} from '../../utils/categories';

interface ChildCategorySummary {
  category: CategoryNode;
  directArticleCount: number;
  subtreeArticleCount: number;
}

interface ArticleGroup {
  initial: string;
  id: string;
  articles: CollectionEntry<'articles'>[];
}

interface Props {
  category: CategoryNode;
  parentCategory?: CategoryNode;
  ancestors: CategoryNode[];
  siblingCategories: CategoryNode[];
  childCategories: ChildCategorySummary[];
  articles: CollectionEntry<'articles'>[];
  descendantCategoryCount: number;
  subtreeArticleCount: number;
}

export async function getStaticPaths() {
  const [allCategories, allArticles] = await Promise.all([
    getCollection('categories'),
    getCollection('articles'),
  ]);
  const hierarchy = buildCategoryHierarchy(allCategories, allArticles);
  const categories = [...hierarchy.byName.values()].sort((a, b) =>
    a.name.localeCompare(b.name, 'ja')
  );

  return categories.map((category) => {
    const parentCategory = category.parentName
      ? hierarchy.byName.get(category.parentName)
      : undefined;
    const ancestors = getCategoryAncestors(category, hierarchy.byName);
    const childCategories = (hierarchy.children.get(category.name) ?? []).map((childCategory) => ({
      category: childCategory,
      directArticleCount: hierarchy.directArticleCount.get(childCategory.name) ?? 0,
      subtreeArticleCount: countSubtreeArticles(
        childCategory.name,
        hierarchy.children,
        hierarchy.directArticleCount
      ),
    }));
    const siblingCategories = parentCategory
      ? (hierarchy.children.get(parentCategory.name) ?? []).filter(
          (childCategory) => childCategory.name !== category.name
        )
      : [];
    const articles = [...(hierarchy.directArticlesByCategory.get(category.name) ?? [])].sort((a, b) =>
      a.data.title.localeCompare(b.data.title, 'ja')
    );
    const descendantCategoryCount = countDescendantCategories(category.name, hierarchy.children);
    const subtreeArticleCount = countSubtreeArticles(
      category.name,
      hierarchy.children,
      hierarchy.directArticleCount
    );

    return {
      params: { slug: category.slug },
      props: {
        category,
        parentCategory,
        ancestors,
        siblingCategories,
        childCategories,
        articles,
        descendantCategoryCount,
        subtreeArticleCount,
      },
    };
  });
}

const {
  category,
  parentCategory,
  ancestors,
  siblingCategories,
  childCategories,
  articles,
  descendantCategoryCount,
  subtreeArticleCount,
} = Astro.props as Props;
const base = import.meta.env.BASE_URL;
const categoryLead =
  category.description ?? `${category.name}に関する記事と下位カテゴリを収録するカテゴリである。`;

const groupedArticles = new Map<string, CollectionEntry<'articles'>[]>();

for (const article of articles) {
  const firstChar = article.data.title.trim().charAt(0) || '他';
  const groupItems = groupedArticles.get(firstChar) ?? [];
  groupItems.push(article);
  groupedArticles.set(firstChar, groupItems);
}

const articleGroups: ArticleGroup[] = [...groupedArticles.entries()].map(
  ([initial, grouped], index) => ({
    initial,
    id: `group-${index + 1}`,
    articles: grouped,
  })
);

const categoryLinkMap = new Map<string, CategoryNode>();

if (parentCategory) {
  categoryLinkMap.set(parentCategory.name, parentCategory);
}

categoryLinkMap.set(category.name, category);

for (const siblingCategory of siblingCategories) {
  categoryLinkMap.set(siblingCategory.name, siblingCategory);
}

const footerCategoryLinks = [...categoryLinkMap.values()];
---

<Layout
  title={`カテゴリ: ${category.name}`}
  description={`カテゴリ「${category.name}」に属するページと下位カテゴリの一覧`}
>
  <header class="category-header">
    <nav class="breadcrumb" aria-label="パンくず">
      <a href={base}>メインページ</a>
      {ancestors.map((ancestorCategory) => (
        <>
          <span class="breadcrumb-separator">›</span>
          <a href={`${base}categories/${encodeURIComponent(ancestorCategory.slug)}`}>
            {ancestorCategory.name}
          </a>
        </>
      ))}
      <span class="breadcrumb-separator">›</span>
      <span class="breadcrumb-current" aria-current="page">{category.name}</span>
    </nav>

    <h1 class="category-title">カテゴリ: {category.name}</h1>
    <p class="category-lead">{categoryLead}</p>
    <p class="category-summary">
      このカテゴリには下位カテゴリ <strong>{descendantCategoryCount}</strong> 件、ページ
      <strong>{subtreeArticleCount}</strong> 件（このページ <strong>{articles.length}</strong> 件）が含まれる。
    </p>
  </header>

  <section class="category-section" aria-labelledby="subcategories-heading">
    <h2 id="subcategories-heading" class="section-title">下位カテゴリ</h2>
    {childCategories.length > 0 ? (
      <ul class="category-item-list">
        {childCategories.map((childCategory) => (
          <li class="category-item">
            <a
              href={`${base}categories/${encodeURIComponent(childCategory.category.slug)}`}
              class="category-item-link"
            >
              <span class="category-item-name">{childCategory.category.name}</span>
              <span class="category-item-count">
                直下 {childCategory.directArticleCount} 件 / 合計 {childCategory.subtreeArticleCount} 件
              </span>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="empty-state">このカテゴリに下位カテゴリは存在しない。</p>
    )}
  </section>

  <section class="category-section" aria-labelledby="pages-heading">
    <h2 id="pages-heading" class="section-title">ページ</h2>
    {articleGroups.length > 0 ? (
      <>
        <nav class="group-index" aria-label="ページ索引">
          {articleGroups.map((articleGroup) => (
            <a href={`#${articleGroup.id}`} class="group-index-link">
              {articleGroup.initial}
            </a>
          ))}
        </nav>

        <div class="group-list">
          {articleGroups.map((articleGroup) => (
            <section id={articleGroup.id} class="article-group">
              <h3 class="article-group-title">{articleGroup.initial}</h3>
              <ul class="page-list">
                {articleGroup.articles.map((article) => (
                  <li class="page-item">
                    <a
                      href={`${base}articles/${encodeURIComponent(article.data.slug ?? article.id)}`}
                      class="page-link"
                    >
                      {article.data.title}
                    </a>
                    <span class="page-description">{article.data.description}</span>
                  </li>
                ))}
              </ul>
            </section>
          ))}
        </div>
      </>
    ) : (
      <p class="empty-state">このカテゴリに属するページはまだ作成されていない。</p>
    )}
  </section>

  {(parentCategory || siblingCategories.length > 0) && (
    <section class="category-section" aria-labelledby="related-heading">
      <h2 id="related-heading" class="section-title">関連カテゴリ</h2>
      <ul class="related-category-list">
        {parentCategory && (
          <li class="related-item">
            <span class="related-label">上位カテゴリ</span>
            <a href={`${base}categories/${encodeURIComponent(parentCategory.slug)}`}>
              {parentCategory.name}
            </a>
          </li>
        )}

        {siblingCategories.map((siblingCategory) => (
          <li class="related-item">
            <span class="related-label">同階層</span>
            <a href={`${base}categories/${encodeURIComponent(siblingCategory.slug)}`}>
              {siblingCategory.name}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <footer class="category-links" aria-label="カテゴリリンク">
    <span class="category-links-label">カテゴリ:</span>
    {footerCategoryLinks.map((linkCategory, index) => (
      <>
        {index > 0 && <span class="category-links-divider">|</span>}
        <a
          href={`${base}categories/${encodeURIComponent(linkCategory.slug)}`}
          class:list={['category-links-link', { 'is-current': linkCategory.name === category.name }]}
          aria-current={linkCategory.name === category.name ? 'page' : undefined}
        >
          {linkCategory.name}
        </a>
      </>
    ))}
  </footer>
</Layout>

<style>
  .category-header {
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--spacing-lg);
  }

  .breadcrumb {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-sm);
  }

  .breadcrumb a {
    color: var(--color-link);
    text-decoration: none;
  }

  .breadcrumb a:visited {
    color: var(--color-link-visited);
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .breadcrumb-separator {
    color: var(--color-text-tertiary);
  }

  .breadcrumb-current {
    color: var(--color-text);
  }

  .category-title {
    font-size: 1.75rem;
    font-weight: 500;
    line-height: 1.2;
    margin-bottom: var(--spacing-sm);
  }

  .category-lead {
    font-size: 0.95rem;
    line-height: 1.65;
    margin-bottom: var(--spacing-sm);
  }

  .category-summary {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
  }

  .category-section {
    margin-bottom: var(--spacing-xl);
  }

  .section-title {
    font-size: 1.2rem;
    font-weight: 500;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: var(--spacing-xs);
    margin-bottom: var(--spacing-sm);
  }

  .category-item-list,
  .page-list,
  .related-category-list {
    list-style: none;
    padding: 0;
  }

  .category-item-list {
    columns: 2;
    gap: var(--spacing-lg);
  }

  .category-item {
    break-inside: avoid;
    margin-bottom: var(--spacing-xs);
  }

  .category-item-link {
    display: inline;
    color: var(--color-link);
    text-decoration: none;
    font-size: 0.9375rem;
    line-height: 1.7;
  }

  .category-item-link:visited {
    color: var(--color-link-visited);
  }

  .category-item-link:hover {
    text-decoration: underline;
  }

  .category-item-name {
    margin-right: 0.45rem;
  }

  .category-item-count {
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
    white-space: nowrap;
  }

  .group-index {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-border-light);
    background-color: var(--color-sidebar-bg);
    margin-bottom: var(--spacing-sm);
  }

  .group-index-link {
    min-width: 1.75rem;
    text-align: center;
    padding: 2px 8px;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    color: var(--color-link);
    text-decoration: none;
    font-size: 0.875rem;
  }

  .group-index-link:visited {
    color: var(--color-link-visited);
  }

  .group-index-link:hover {
    border-color: var(--color-border);
    text-decoration: none;
  }

  .group-list {
    display: grid;
    gap: var(--spacing-md);
  }

  .article-group {
    border-top: 1px solid var(--color-border-light);
    padding-top: var(--spacing-sm);
  }

  .article-group-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
  }

  .page-item {
    padding: var(--spacing-xs) 0;
    border-bottom: 1px solid var(--color-border-light);
  }

  .page-item:last-child {
    border-bottom: none;
  }

  .page-link {
    color: var(--color-link);
    text-decoration: none;
    margin-right: 0.4rem;
  }

  .page-link:visited {
    color: var(--color-link-visited);
  }

  .page-link:hover {
    text-decoration: underline;
  }

  .page-description {
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
    line-height: 1.6;
  }

  .related-category-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm) var(--spacing-lg);
  }

  .related-item {
    display: flex;
    align-items: baseline;
    gap: var(--spacing-xs);
    font-size: 0.9rem;
  }

  .related-label {
    color: var(--color-text-secondary);
    font-size: 0.75rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .category-links {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-top: var(--spacing-xl);
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-border);
    background-color: var(--color-sidebar-bg);
    font-size: 0.875rem;
  }

  .category-links-label {
    color: var(--color-text-secondary);
  }

  .category-links-divider {
    color: var(--color-text-tertiary);
  }

  .category-links-link {
    color: var(--color-link);
    text-decoration: none;
  }

  .category-links-link:visited {
    color: var(--color-link-visited);
  }

  .category-links-link:hover {
    text-decoration: underline;
  }

  .category-links-link.is-current {
    color: var(--color-text);
    font-weight: 600;
    pointer-events: none;
  }

  .empty-state {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .category-item-list {
      columns: 1;
    }

    .page-description {
      display: block;
      margin-top: 2px;
    }
  }
</style>
